name: Build & Release APK

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag override (e.g. v1.2.0). Leave empty to auto-detect from build.gradle.kts."
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Extract version from build.gradle.kts
        id: version
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          VERSION_CODE=$(grep 'versionCode' app/build.gradle.kts | head -1 | sed 's/[^0-9]//g')
          echo "name=$VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION_NAME ($VERSION_CODE)"

      - name: Determine release tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="v${{ steps.version.outputs.name }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Release tag: $TAG"

      - name: Decode release keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/release.keystore
          echo "KEYSTORE_PATH=release.keystore" >> "$GITHUB_ENV"

      - name: Set release signing env
        if: env.KEYSTORE_PATH != ''
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "STORE_PASSWORD=$STORE_PASSWORD" >> "$GITHUB_ENV"
          echo "KEY_ALIAS=$KEY_ALIAS" >> "$GITHUB_ENV"
          echo "KEY_PASSWORD=$KEY_PASSWORD" >> "$GITHUB_ENV"

      - name: Build release APKs
        if: env.KEYSTORE_PATH != ''
        run: ./gradlew assembleArm64Release assembleX86_64Release --no-daemon

      - name: Create debug keystore
        if: env.KEYSTORE_PATH == ''
        run: |
          mkdir -p ~/.android
          keytool -genkeypair \
            -alias androiddebugkey \
            -keypass android \
            -keystore ~/.android/debug.keystore \
            -storepass android \
            -dname "CN=Android Debug,O=Android,C=US" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000

      - name: Build debug APKs (no signing keys)
        if: env.KEYSTORE_PATH == ''
        run: ./gradlew assembleArm64Debug assembleX86_64Debug --no-daemon

      - name: Collect APKs
        id: apks
        run: |
          mkdir -p artifacts
          BUILD_TYPE="release"
          if [ -z "$KEYSTORE_PATH" ]; then
            BUILD_TYPE="debug"
          fi

          find app/build/outputs/apk -name "*.apk" -exec cp {} artifacts/ \;

          TAG="${{ steps.tag.outputs.tag }}"
          cd artifacts
          for f in *.apk; do
            case "$f" in
              *arm64*) mv "$f" "Musika-${TAG}-arm64-${BUILD_TYPE}.apk" 2>/dev/null || true ;;
              *x86_64*|*x86*) mv "$f" "Musika-${TAG}-x64-${BUILD_TYPE}.apk" 2>/dev/null || true ;;
            esac
          done

          echo "build_type=$BUILD_TYPE" >> "$GITHUB_OUTPUT"
          ls -la

      - name: Prepare release body
        run: |
          git log -1 --pretty=%B > release_body.md
          PREV=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || true)
          if [ -n "$PREV" ]; then
            echo "" >> release_body.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV}...${{ steps.tag.outputs.tag }}" >> release_body.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body_path: release_body.md
          files: artifacts/*.apk
          fail_on_unmatched_files: true
          make_latest: true
