name: Release Desktop (Windows)

on:
  push:
    branches: [desktop-release]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        shell: pwsh
        run: |
          choco install rust -y
          rustup default stable

      - name: Install Windows build tools
        shell: pwsh
        run: |
          choco install wixtoolset -y

      - name: Install desktop dependencies
        working-directory: desktop
        run: npm install

      - name: Extract version from tauri.conf.json
        id: version
        shell: pwsh
        run: |
          $raw = Get-Content desktop/src-tauri/tauri.conf.json | Select-String '"version"' | Select-Object -First 1
          $version = $raw -replace '.*"version"\s*:\s*"([^"]+)".*','$1'
          "name=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Determine release tag
        id: tag
        shell: pwsh
        run: |
          $tag = "desktop-v${{ steps.version.outputs.name }}"
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build desktop bundle
        working-directory: desktop
        run: npm run build

      - name: Collect installers
        id: bundle
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          Get-ChildItem desktop/src-tauri/target/release/bundle/msi -Filter *.msi -ErrorAction SilentlyContinue | Copy-Item -Destination artifacts
          Get-ChildItem desktop/src-tauri/target/release/bundle/nsis -Filter *.exe -ErrorAction SilentlyContinue | Copy-Item -Destination artifacts
          Get-ChildItem artifacts

      - name: Prepare release body
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.name }}"
          $changelog = "CHANGELOG_DESKTOP.md"
          if (Test-Path $changelog) {
            $lines = Get-Content $changelog
            $startMatch = $lines | Select-String -Pattern "## \[$version\]" | Select-Object -First 1
            if ($startMatch) {
              $start = $startMatch.LineNumber
              $nextMatch = $lines | Select-String -Pattern "^## \[" | Where-Object { $_.LineNumber -gt $start } | Select-Object -First 1
              if ($nextMatch) {
                $end = $nextMatch.LineNumber - 1
              } else {
                $end = $lines.Length
              }
              $section = $lines[($start - 1)..($end - 1)]
              $section | Out-File release_body.md
            } else {
              "## [$version]" | Out-File release_body.md
              "- No desktop release notes found in CHANGELOG_DESKTOP.md." | Add-Content release_body.md
            }
          } else {
            git log -1 --pretty=%B | Out-File release_body.md
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body_path: release_body.md
          files: artifacts/*
          fail_on_unmatched_files: true
          make_latest: true
